---
- name: Update the apt cache
  apt: 
    update_cache: yes
    cache_valid_time: 86400
  #become: true
  tags: dependency

# - name: Upgrade kali
#   apt:
#     upgrade: yes
#   become: true
#   tags: dependency

# - name: Update packages
#   apt:
#     upgrade: safe
#     cache_valid_time: 86400

# - name: Update packages to the latest version
#   apt:
#     upgrade: dist
#     cache_valid_time: 86400

- name: Create Tools Destination Folder
  file:
    path: "{{ tools_destination_folder | default('$HOME/tools') }}"
    state: directory
    owner: "{{ username }}"
  become_user: "{{ username | default('vagrant')}}"
  tags: dependency

- name: Change password
  user:
    name: "{{ username | default('vagrant')}}"
    password: "{{ user_password | password_hash('sha512')}}"
    state: present
    createhome: yes
    groups: sudo
    append: true
  become: true
  no_log: true
  tags: dependecy

- name: Install pipx
  apt:
    name: pipx
  become: true
  tags: web, cloud, dependency

- name: pipx ensurepath
  shell: 
    cmd: pipx ensurepath
  become_user: "{{ username | default('vagrant')}}"
  tags: web, cloud, dependency

- name: Install seclists
  apt: 
    name: seclists
    state: latest
  become: true
  tags: web, dependency

- name: Install fzf
  apt:
    name: fzf
    state: latest
  become: true
  tags: dependency

- name: Install tmux
  apt:  
    name: tmux
    state: latest
  become: true
  tags: dependency

- name: Set timezone to {{ config_system_timezone }}
  timezone:
    name: "{{ config_system_timezone }}"

# - name: Set Keyboard
#   shell: |
#     export DISPLAY=:0.0
#     setxkbmap -layout {{keyboard_layout}}
#   become: true
#   become_user: "{{ username | default('vagrant')}}"
#   tags: dependency
  
- name: Set Keyboard
  lineinfile:
    path: /etc/default/keyboard
    regexp: '^XKBLAYOUT="us"'
    line: XKBLAYOUT="{{keyboard_layout}}"
  #become: true

# - name: Reload keyboard configuration
#   systemd:
#     name: keyboard-setup.service
#     state: restarted
#   become: true

- name: Remove useless packages from the cache
  apt:
    autoclean: yes

- name: Remove dependencies that are no longer required
  apt:
    autoremove: yes
